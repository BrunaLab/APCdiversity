---
title: "APC Paper: Figures & Tables"
date: "7 July 2020"
output: pdf_document

# author: |
#   | Author 1^[Corresponding author: ---@ufl.edu] $^1$,$^2$, Author 2 $^1$, Author 3 $^2$
#   | $^1$WEC,  $^2$LAS
# 
# abstract: |
#   Text of abstract.
# 
# <!-- bibliography: Path to your .bib file -->
# <!-- csl: Path to your .csl file #sets the style of your bibliography -->

fig_caption: yes
always_allow_html: yes

# These are LaTex settings to take care of floating figures/tables, line spacing, etc
header-includes:
  - \usepackage{endfloat}
  - \usepackage{setspace}\doublespacing
  - \usepackage{lineno}
  - \linenumbers
# 
pdf_document:
extra_dependencies: "subfig"

---



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,message=FALSE,warning=FALSE)

library(dplyr)
library(tidyr)
library(ggplot2)
library(gridExtra)
library(kableExtra)
library(readr)
```

```{r raw_data}
knitr::opts_chunk$set(echo = FALSE)
AllData<-read_csv(file="./data_clean/AllData.csv")
NO_USA_CHN_FL<-read_csv(file="./data_clean/NO_USA_CHN_FL.csv")

AllData_noUSAorCHN<-read_csv(file="./data_clean/AllData_noUSAorCHN.csv")

# need to systematize - don't import these, use the script below to process
one_author_pubs_ALL<-read_csv(file="./data_clean/one_author_pubs_ALL.csv")
coauthor_pubs_ALL<-read_csv(file="./data_clean/coauthor_pubs_ALL.csv")

bootstrap_results<-read_csv('./output/bootstrap_results.csv')
bootstrap_results_countries<-read_csv("./output/bootstrap_results_countries.csv")
Table2.2<-read.csv('./output/Table2.2.csv')
```



## Summary Stats

```{r PUBLISTS, cached=TRUE}
one_author_pubs <- AllData %>%
  group_by(DOI) %>% 
  summarize(n=n_distinct(AuthorNum)) %>% 
  filter(n==1) %>% 
  select(-n) %>% 
  left_join(AllData,by="DOI")

coauthor_pubs<- AllData %>%
  group_by(DOI) %>% 
  summarize(n=n_distinct(AuthorNum)) %>% 
  filter(n>=2) %>% 
  left_join(AllData,by="DOI")

one_author_pubsNOCHNUSA <- NO_USA_CHN_FL %>%
  group_by(DOI) %>% 
  summarize(n=n_distinct(AuthorNum)) %>% 
  filter(n==1) %>% 
  select(-n) %>% 
  left_join(NO_USA_CHN_FL,by="DOI")

coauthor_pubsNOCHNUSA<- NO_USA_CHN_FL %>%
  group_by(DOI) %>% 
  summarize(n=n_distinct(AuthorNum)) %>% 
  filter(n>=2) %>% 
  left_join(NO_USA_CHN_FL,by="DOI") 
```

```{r njournals}
n_journals <- AllData %>% 
  group_by(JrnlType) %>% 
  summarize(n=n_distinct(Journal))
tot_njournals<-sum(n_journals[2])
```
### Total Journals: N = `r tot_njournals`.

```{r npapers}
NumbArticles_JrnlType <- AllData %>% #number of papers per journal
  group_by(JrnlType) %>% 
  summarize(n=n_distinct(DOI))

NumbSoloArticles_JrnlType<-one_author_pubs %>% 
group_by(JrnlType) %>% 
  summarize(n=n_distinct(DOI))

NumbCoAuthoredArticles_JrnlType<-coauthor_pubs %>% 
group_by(JrnlType) %>% 
  summarize(n=n_distinct(DOI))

n_OA<-NumbArticles_JrnlType[1,2]
n_PW<-NumbArticles_JrnlType[2,2]
Total_pubs<-n_OA+n_PW
```
### Articles in Paywall journals: N = `r NumbArticles_JrnlType[2,2]`
* single author: N = `r NumbSoloArticles_JrnlType[2,2]`
* Co-authored: N = `r NumbCoAuthoredArticles_JrnlType[2,2]`

### Articles in Open Access journals: N = `r NumbArticles_JrnlType[1,2]` 
* single author: N = `r NumbSoloArticles_JrnlType[1,2]`
* Co-authored: N = `r NumbCoAuthoredArticles_JrnlType[1,2]`

### Total Number of Articles: N = `r Total_pubs`

```{r ncountries}
# Total by Journal Type
n_countriesAll<-AllData %>% 
  summarize(n_distinct(Code))

n_countries<-AllData %>% 
  group_by(JrnlType) %>% 
  summarize(n_distinct(Code))
# Countries: First Authors by Jrnl Type (including solo authored pubs)
countries_first<-AllData %>% 
  filter(AuthorNum==1) %>% 
  group_by(Code,JrnlType) %>% 
  select(Code,IncomeGroup,Region,JrnlType) %>% 
  slice(1)
ncountries_first<-ungroup(countries_first) %>% 
  group_by(JrnlType) %>% 
  tally(n_distinct(Code))
# countries Last Authors by jrnl type
countries_last<-AllData %>% 
  group_by(DOI) %>% 
  filter(AuthorNum == max(AuthorNum)) %>%
  group_by(Code,JrnlType) %>% 
  select(Code,IncomeGroup,Region,JrnlType) %>% 
  slice(1)
ncountries_last<-ungroup(countries_last) %>% 
  group_by(JrnlType) %>% 
  tally(n_distinct(Code))
```
#### Number of Countries: All authors, All Journals
* N = `r n_countriesAll`


### Number of Countries in PW journals
* All authors N = `r n_countries[2,2]` 
* First Authors N = `r ncountries_first[2,2]`
* Last Authors N = `r ncountries_last[2,2]`

### Number of Countries in OA journals
* All authors N = `r n_countries[1,2]` 
* First Authors N = `r ncountries_first[1,2]`
* Last Authors N = `r ncountries_last[1,2]`



```{r rich_div_figs}
knitr::opts_knit$set(eval.after = "fig.cap")
insert_custom1<-n_OA
insert_custom2<-n_PW
source("./Rscript/functions_figures/RichBootFig.R")
RichBootFig<-RichBootFig(bootstrap_results,Table2.2)
source("./Rscript/functions_figures/DivBootFig.R")
DivBootFig<-DivBootFig(bootstrap_results,Table2.2)
```

```{r RichFig, fig.align='center', fig.cap=paste("Fig 1. Author Geographic Richness for N = ", insert_custom1, " Open Access articles (red bar) and 1000 identically sized collections of Paywalled articles (selected by bootstrapping from a pool of ",insert_custom2, " articles)."), fig.height = 9,fig.width=13,out.extra='angle=90'}
RichBootFig
```


```{r DivFig, fig.align='center', fig.cap=paste("Fig 2. Author Geographic Diversity for N = ", insert_custom1, " Open Access articles (red bar) and 1000 identically sized collections of Paywalled articles (selected by bootstrapping from a pool of ",insert_custom2, " articles)."), fig.height = 9,fig.width=13,out.extra='angle=90'}
DivBootFig
```

```{r geo_figs}
source("./Rscript/functions_figures/Fig3.R") 
p1<-Fig3(one_author_pubs,"author_first","OA")
p2<-Fig3(one_author_pubs,"author_first","PW")
p3<-Fig3(coauthor_pubs,"author_first","OA")
p4<-Fig3(coauthor_pubs,"author_first","PW")
p5<-Fig3(coauthor_pubs,"author_last","OA")
p6<-Fig3(coauthor_pubs,"author_last","PW")
```

```{r geo_fig3, fig.align='center',fig.cap="Fig 3. Proportion of authors based in different countries for single-author publications in (A) Open Access journals, and (B) Paywall journals.",fig.height = 9,fig.width=7}
grid.arrange(p1, p2, ncol = 1)
```

```{r geo_fig4, fig.align='center',fig.cap="Fig 4. Proportion of first authors based in different countries for Co-authored publications in (A) Open Access journals, and (B) Paywall journals.",fig.height = 9,fig.width=7}
# coauthored, first author, OA
grid.arrange(p3, p4, ncol = 1)
```

```{r geo_figs6, fig.align='center', fig.cap="Fig 5. Proportion of last authors based in different countries for Co-authored Publications in (A) Open Access journals, and (B) Paywall journals.",fig.height = 9,fig.width=7}
grid.arrange(p5, p6, ncol = 1)
```

```{r IncomeFig,fig.align='center',fig.cap="Fig 6: Percentage of first authors of open access articles (red bars) and 1000 bootstrapped collections of paywalled articles that are based in different national income categories.",fig.height = 9,fig.width=7}
source("./Rscript/functions_figures/AltFig1_hist.R") 
AltFig1_hist(bootstrap_results,bootstrap_results_countries,"author_first" ,"All")
```

```{r RegionFig, fig.align='center', fig.cap="Fig 7. Percentage of first authors of open access articles (red bars) and 1000 bootstrapped collections of paywalled articles that are based in different global regions.",fig.height = 9,fig.width=7}
source("./Rscript/functions_figures/Fig7.R") 
Fig7(bootstrap_results,bootstrap_results_countries,"author_first" ,"All")
```

### Table1
```{r Table1}
source("./Rscript/functions/SummaryTable.R") 
Tables<-SummaryTable(AllData)
Table1<-Tables[2]
Table1<-as.data.frame(Table1)
names(Table1)<-c("Journal","Articles (n)","OA Mirror Articles (n)","APC ($)")
Table1[4,1]<-"BiochimieSuper1"
Table1[26,1]<-"Microelectronic EngineeringSuper2"
Table1[37,4]<-""

tmp<-knitr::kable(Table1, 
      digits = 2,
      align="c",
      format="latex",
      row.names = FALSE,
      booktabs=T,
      caption = "Elsevier subscription journals, the number of articles published in the subscription  journals and their open access mirrors, and the article processing charge (APC) for each open access journal.") %>%
  kable_styling(bootstrap_options = c("hover"),
                full_width = F,
                font_size = 12,
                position = "left") %>%
  footnote(number = c("OA Mirror title: Biochimie Open", "OA Mirror title: Micro and Nano Engineering"))
tmp<-str_replace(tmp, "Super1", "$^{1}$")
tmp<-str_replace(tmp, "Super2", "$^{2}$")
knitr::asis_output(tmp)
```


### Table2
```{r Table2}
SubsampledPW.results_Solo<-read_csv('output/SubsampledPW.results_RichDiv_SOLO_ALL.csv')
SubsampledPW.results_Solo_NoUSACHN<-read_csv('output/SubsampledPW.results_RichDiv_SOLO_ALL.csv')
one_author_pubs_ALL<-read_csv(file="./data_clean/one_author_pubs_ALL.csv")
coauthor_pubs_ALL<-read_csv(file="./data_clean/coauthor_pubs_ALL.csv")
one_author_pubsNOCHNUSA<-read_csv(file="./data_clean/one_author_pubsNOCHNUSA.csv")
coauthor_pubsNOCHNUSA<-read_csv(file="./data_clean/coauthor_pubsNOCHNUSA.csv")
source("./Rscript/functions_figures/Table2.R")
Table2<-Table2()
Table2<-as.data.frame(Table2)
names(Table2)<-c("Metric","Author","OA","Mean PW",
                       "PW 95% CI", "OA",
                       "Mean PW","PW 95% CI")
kable(Table2, 
      digits = 1, 
      format = "latex", 
      align="c",
      row.names = FALSE, 
      booktabs=T,
      caption = "Geographic Richness and Diversity of different author types (Single, First, Last) for papers published in Open Access (OA) and Paywalled (PW) journals.") %>% 
  kable_styling(bootstrap_options = c("hover"),
                latex_options = c("scale_down"),
                full_width = F,
                font_size = 12,
                position = "left") %>% 
  add_header_above(c(" " = 2, "All Countries" = 3, "USA & China Excluded" = 3))
```


# Appendices

```{r Appendix1,fig.align='center',fig.cap="Appendix 1: Number of first authors based in different countries (paywall and open access journals; 'first authors' includes the authors of sole-authored papers)."}
source("./Rscript/functions_figures/AppFig1.R") 
AppFig1(AllData)
```

```{r Appendix2a, fig.align='center', fig.cap="Appendix 2a. Percentage of last authors of open access articles (red bars) and 1000 bootstrapped collections of paywalled articles that are based in different National Income groups. Results are similar for last- and solo-authors (see Appendix).",fig.height = 9,fig.width=7}
source("./Rscript/functions_figures/AltFig1_hist.R") 
AltFig1_hist(bootstrap_results,bootstrap_results_countries,"author_last","All")
```

```{r Appendix2b, fig.align='center', fig.cap="Appendix 2b. Percentage of single authors of open access articles (red bars) and 1000 bootstrapped collections of paywalled articles that are based in different National Income groups. Results are similar for last- and solo-authors (see Appendix)." ,fig.height = 9,fig.width=7}
source("./Rscript/functions_figures/AltFig1_hist.R") 
AltFig1_hist(bootstrap_results,bootstrap_results_countries,"solo","All")
```

```{r Appendix3a, fig.align='center', fig.cap="Fig Appendix 3a. Percentage of last authors of open access articles (red bars) and 1000 bootstrapped collections of paywalled articles that are based in different global regions.",fig.height = 9,fig.width=7}
source("./Rscript/functions_figures/Fig7.R") 
Fig7(bootstrap_results,bootstrap_results_countries,"author_last" ,"All")
```

```{r Appendix3b, fig.align='center', fig.cap="Fig Appendix 3b. Percentage of single authors of open access articles (red bars) and 1000 bootstrapped collections of paywalled articles that are based in different global regions.",fig.height = 9,fig.width=7}
source("./Rscript/functions_figures/Fig7.R") 
Fig7(bootstrap_results,bootstrap_results_countries,"solo" ,"All")
```

```{r AppTable1}
stipends<-read_csv(file="./data_clean/stipends.csv")
stipends<-as.data.frame(stipends)
stipends<-stipends %>% select(country, degree,stipend_USD,source)
names(stipends)<-c("Country","Degree","Monthly Stipend ($)","Source")
kable(stipends, 
      digits = 1, 
      format = "latex", 
      align="c",
      row.names = FALSE, 
      booktabs=T,
      caption = "Stipends for Graduate Stude in Select Countries") %>% 
  kable_styling(bootstrap_options = c("hover"),
                latex_options = c("scale_down"),
                full_width = F,
                font_size = 12,
                position = "left")
  
```
